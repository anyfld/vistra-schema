# 独自PTZプロトコル仕様書 (CEP-PTZ Protocol)

## 1. システムアーキテクチャ定義

| 略称 | 名称 | 役割 |
|------|------|------|
| CR | Control Room (Server) | 命令のキュー管理、優先度判定、FDへの命令配信、状態管理を行うシステムの中枢。 |
| EP | Executive Producer (Controller) | 演出意図に基づくPTZ操作の発信元。ユーザーUIやシネマティックプログラムの実行指示を行う。 |
| FD | Film Director (Camera) | 実際にPTZ動作を行うカメラデバイス。CRへポーリングを行い、演出指示（信号）を受信・実行する。 |

## 2. 通信方式（Connect Protocol）

FDは定期的（デフォルト 500ms間隔）にCRへポーリングを行います。本プロトコルでは、通信効率化のためポーリングと完了通知を同一のエンドポイントで行います。

### 2.1 ポーリング・シーケンス

**FD → CR: POST /polling**

- **Payload**: デバイスID, 現在のステータス, 直前に完了した completedTaskId (任意), 現在実行中の executingTaskId.
- **タイミング**: 定期タイマー、またはタスク完了時の即時実行。

**CR → FD: Response**

- **Payload**: 現在の命令, 次の命令[Pre-fetch], 中断フラグ.

`completedTaskId` を受け取った場合、CRは該当タスクをデキューし、次の命令をスライドさせます。

## 3. 命令・キュー管理ロジック

### 3.1 サーバー側キューイング

CRは各FDに対して「PTZ枠キュー」と「シネマティック枠キュー」の2層を保持します。

**一個次まで送信（Look-ahead）**: FDには実行中のタスクに加え、次に控えているタスクの最大2件を同時に渡します。

### 3.2 中断・割り込み処理

**PTZによる割り込み**: EPからPTZ命令（Layer 1）が届いた場合、CRはシネマティック枠のキューを即座に全削除（デキュー）し、実行中のシネマティック動作を中断させます。

FDはポーリングレスポンス内の `interrupt: true` を検知した瞬間に現在の物理動作を停止し、新しく届いたPTZ命令に切り替えます。

## 4. 優先度制御（レイヤー構造）

| レイヤー | カテゴリ | 命令セット | 優先度 | 動作 |
|----------|----------|------------|--------|------|
| Layer 1 | PTZ枠 | ONVIF Operations (Sec 5) | 高 | 到着時、Layer 2を全て破棄・中断する（ディレクターによる緊急操作）。 |
| Layer 2 | Cinematic枠 | 独自仕様 (Sec 6) | 低 | PTZ枠が空の時のみ実行（自動演出）。 |

## 5. PTZ枠命令（ONVIFベース）

主にマニュアル操作で使用される低レイヤ命令です。

### 5.1 Absolute Move (絶対指定)

指定座標への移動。完了通知の対象。

```json
{
  "op": "AbsoluteMove",
  "position": {
    "x": 0.5,
    "y": -0.2,
    "z": 1.0
  },
  "speed": {
    "x": 1.0,
    "y": 1.0
  }
}
```

### 5.2 Relative Move (相対指定)

現在値からの相対移動。完了通知の対象。

```json
{
  "op": "RelativeMove",
  "translation": {
    "x": 0.1,
    "y": 0.0
  }
}
```

### 5.3 Continuous Move (連続移動)

速度指定。ジョイスティック用。完了通知不要（最新値上書き）。

```json
{
  "op": "ContinuousMove",
  "velocity": {
    "x": 0.5,
    "y": 0.0
  },
  "timeout": 500
}
```

## 6. シネマティック枠命令（独自方式）

本セクションは、演出や自動巡回で使用される上位レベルの命令セットを定義します。
データ構造および動作仕様は、EP（Executive Producer）の演出要件に基づき、PTZ枠（Sec 5）とは独立した独自の仕組みとして制定されます。

現時点では予約枠とし、具体的なペイロード定義は保留します。

## 7. FDの実装要件

**デュアルバッファ実行**:

命令の `type` (PTZ or Cinematic) に関わらず、`commands[0]` 完了前に `commands[1]` を準備します。

**クロスオーバー防止**: シネマティック実行中にPTZ命令が届いた場合、FDは即座にシネマティック命令を破棄してPTZを優先します。

**即時ポーリング**: タスク（`taskId`）完了時、即座に `POST /polling` を行い、完了報告と次命令の取得を行います。

**強制停止処理**: `interrupt: true` 受信時は、現在のタスクを中断し、キューの先頭にある新しい命令（通常はPTZ割り込み）へ移行します。
